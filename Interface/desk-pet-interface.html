<!doctype html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.0/font/bootstrap-icons.css">
  <title>DESKPET</title>
  <style>

    body {
      font-family: Helvetica;
      background: #181818;
      color: #EFEFEF;
      font-size: 16px;
      margin: 0
    }

    #header-top {
      background-color: #393939;
      height: 60px;
    }

    #lynx-logo{
      position: absolute;
      top: 0;
      padding: 5px 10px;
      height: 90px;
    }

    #deskpet {
      position: absolute;
      top: 5px;
      right: 5px;
      font-size: 30px;
      font-weight: bold;
      padding: 10px;
    }

    .trapezoid {
      position: absolute;
      top: 45px;
      border-top: 60px solid #393939;
      border-right: 60px solid transparent;
      width: 220px;
    }

    #nav-bar {
      display: flex;
      flex-wrap: wrap;
      justify-content: flex-end;
      background-color: #feaf3c;
      min-height: 40px;
      padding: 0 3px;
    }

    #nav-space{
      flex-grow: 1;
      background-color: #feaf3c;
      width: 240px;
      height: 35px;
    }

    .nav-buttons {
      background: #393939;
      color: #fff;
      font-size: 20px;
      margin: 5px 3px;
      padding: 5px;
      border: 0;
      cursor: pointer;
    }

    .button {
      margin: 5px;
      padding: 0 12px;
      border: 0;
      cursor: pointer;
      color: #fff;
      background: #feaf3c;
      border-radius: 5px;
      font-size: 20px;
      outline: none;
      box-shadow: 0 5px #999;
    }

    .button:hover {
      background-color: #fe933c;
    }

    .button:active {
      background-color: #fe933c;
      box-shadow: 0 2px #999;
      transform: translateY(4px);
    }

    button.disabled {
      cursor: default;
      background: #999
    }

    #rc-settings, #face-settings, #settings, #information {
      position: absolute;
      right: 0;
      padding: 10px;
      background-color: rgba(0,0,0,0.3)
    }

    #rc-settings{
      width: 200px;
    }

    #fname{
      width: 100px;
      font-size: 14px;
      margin: 5px;
      padding: 1px;
    }

    .inline-button{
      line-height: 18px;
      font-size: 16px;
      border-radius: 0;
      padding: 0 7px;
      box-shadow: 0 4px #999;
    }

    .inline-button:active {
      background-color: #fe933c;
      box-shadow: 0 2px #999;
    }

    #control-buttons {
      position: absolute;
      top: 260px;
      right: 0;
      padding: 20px 10px
    }

    #base {
      margin-left: auto;
      margin-right: auto;
      margin-top: 30px;
      border-radius: 50%;
      width: 80px;
      height: 80px;
      background: #999;
    }

    #stick {
      margin-left: 25px;
      margin-top: 25px;
      width: 30px;
      height: 30px;
    }

    .rc-buttons {
      font-weight: bold;
      display: flex;
      justify-content: center;
      align-items: center;
      border-radius: 50%;
      font-size: 20px;
      width: 35px;
      height: 35px
    }

    .hidden {
      display: none
    }

    .input-group {
      display: flex;
      flex-wrap: nowrap;
      justify-content: space-between;
      line-height: 22px;
      margin: 5px
    }

    .input-group>label {
      display: inline-block;
      padding-bottom: 10px;
      min-width: 40%
    }

    .range-max, .range-min {
      display: inline-block;
      padding: 0 5px
    }

    input[type=range] {
      -webkit-appearance: none;
      width: 100%;
      height: 22px;
      background: rgba(51, 51, 54, 0.3);
      cursor: pointer;
      border-radius: 40px;
      margin: 0
    }

    input[type=range]:focus {
      outline: 0
    }

    input[type=range]::-webkit-slider-runnable-track {
      width: 100%;
      height: 2px;
      cursor: pointer;
      background: #EFEFEF;
      border-radius: 0;
      border: 0 solid #EFEFEF
    }

    input[type=range]::-webkit-slider-thumb {
      border: 1px solid rgb(0, 0, 30);
      height: 22px;
      width: 22px;
      border-radius: 50px;
      background: #feaf3c;
      cursor: pointer;
      -webkit-appearance: none;
      margin-top: -11.5px
    }

    input[type=range]:focus::-webkit-slider-runnable-track {
      background: #EFEFEF
    }

    input[type=range]::-moz-range-track {
      width: 100%;
      height: 2px;
      cursor: pointer;
      background: #EFEFEF;
      border-radius: 0;
      border: 0 solid #EFEFEF
    }

    input[type=range]::-moz-range-thumb {
      border: 1px solid rgb(0, 0, 30);
      height: 22px;
      width: 22px;
      border-radius: 50px;
      background: #feaf3c;
      cursor: pointer
    }

    input[type=range]::-ms-track {
      width: 100%;
      height: 2px;
      cursor: pointer;
      background: 0 0;
      border-color: transparent;
      color: transparent
    }

    input[type=range]::-ms-fill-lower {
      background: #EFEFEF;
      border: 0 solid #EFEFEF;
      border-radius: 0
    }

    input[type=range]::-ms-fill-upper {
      background: #EFEFEF;
      border: 0 solid #EFEFEF;
      border-radius: 0
    }

    input[type=range]::-ms-thumb {
      border: 1px solid rgb(0, 0, 30);
      height: 22px;
      width: 22px;
      border-radius: 50px;
      background: #feaf3c;
      cursor: pointer;
      height: 2px
    }

    input[type=range]:focus::-ms-fill-lower {
      background: #EFEFEF
    }

    input[type=range]:focus::-ms-fill-upper {
      background: #363636
    }

    .switch {
      display: block;
      position: relative;
      line-height: 22px;
      font-size: 16px;
      height: 22px
    }

    .switch input {
      outline: 0;
      opacity: 0;
      width: 0;
      height: 0
    }

    .slider {
      width: 50px;
      height: 22px;
      border-radius: 22px;
      cursor: pointer;
      background-color: #999;
    }

    .slider,
    .slider:before {
      display: inline-block;
      transition: .4s
    }

    .slider:before {
      position: relative;
      content: "";
      border-radius: 50%;
      height: 16px;
      width: 16px;
      left: 4px;
      top: 3px;
      background-color: #fff
    }

    input:checked+.slider {
      background-color: #feaf3c;
    }

    input:checked+.slider:before {
      -webkit-transform: translateX(26px);
      transform: translateX(26px)
    }

    select {
      border: 1px solid #181818;
      font-size: 14px;
      height: 22px;
      outline: 0;
      border-radius: 5px
    }

    .save {
      position: absolute;
      right: 210px;
      top: 18px;
      height: 15px;
      line-height: 15px;
      padding: 5px;
      text-decoration: none;
      cursor: pointer
    }

    .close {
      position: absolute;
      right: 15px;
      top: 15px;
      background: #ff3034;
      width: 20px;
      height: 20px;
      border-radius: 100px;
      color: #fff;
      text-align: center;
      text-justify: center;
      line-height: 22px;
      cursor: pointer
    }

    #content {
      display: flex;
      flex-wrap: nowrap;
      align-items: stretch
    }

    figure img {
      display: block;
      max-width: 95%;
      max-height: calc(100vh - 120px);
      width: auto;
      height: auto
    }

    figure {
      padding: 0 0 0 0px;
      margin: 0
    }

    #video-container, #video, #canvas {
      position: absolute;
      margin-left: auto;
      margin-right: auto;
      margin-top: 0;
      max-width: 95%;
      left: 0;
      right: 0;
      padding: 5px;
      border: none;
      z-index: -1
    }

  </style>

</head>

<body>

  <header>
      <div id="header-top"><div id="deskpet">DeskPet</div></div>
        <nav>
          <section id="nav-bar">
            <button class="nav-buttons" id="nav-space"></button>
            <button class="nav-buttons" id="toggle-stream"><i class="bi-camera-video"></i></button>
            <button class="nav-buttons disabled" id="get-still" disabled="disabled"><i class="bi-camera"></i></button>
            <button class="nav-buttons disabled" id="ball-track" disabled="disabled"><i class="bi-dribbble"></i></button>
            <button class="nav-buttons disabled" id="sign-detect" disabled="disabled"><i class="bi-stoplights"></i></button>
            <button class="nav-buttons disabled" id="object-detect" disabled="disabled"><i class="bi-bounding-box"></i></button>
            <button class="nav-buttons disabled" id="face-detect" disabled="disabled"><i class="bi-person-bounding-box"></i></button>
            <button class="nav-buttons disabled" id="face-add" disabled="disabled"><i class="bi-person-plus"></i></button>
            <button class="nav-buttons disabled" id="face-recog" disabled="disabled"><i class="bi-person-check"></i></button>
            <button class="nav-buttons" id="rc-control"><i class="bi-controller"></i></button>
            <button class="nav-buttons" id="cam-settings"><i class="bi-gear"></i></button>
            <button class="nav-buttons" id="info"><i class="bi-info-circle"></i></button>
          </section>
        </nav>
      <img class="trapezoid"></img>
      <img id="lynx-logo" src="https://www.robotshop.com/info/wiki/lynxmotion/download/FlamingoThemes/Iceberg/lynxmotion-logo-600-beta.png" />
  </header>

  <div id="face-settings" class="hidden">
    <label for="fname" size="2">Face ID:</label>
    <input type="text" id="fname" name="fname"/>
    <button class="button inline-button" id="save-id">Save</button>
    <hr style="width:100%">
    <div style="margin-top: 8px;">
      <span style="font-weight: bold;">Saved IDs</span>
    </div>
    <hr style="width:100%">
    <div id="face-ID"></div>
  </div>

  <div id="control-box" class="hidden">
    <div id="rc-settings">
      <div class="input-group" id="speed-group">
        <label for="speed">Speed</label>
        <div class="range-min">0</div>
        <input type="range" id="speed" min="0" max="10" value="5" class="default-action">
        <div class="range-max">10</div>
      </div>
      <div class="input-group" id="height-group">
        <label for="height">Height</label>
        <div class="range-min">0</div>
        <input type="range" id="height" min="0" max="10" value="5" class="default-action">
        <div class="range-max">10</div>
      </div>
      <div class="input-group" id="angle-group">
        <label for="angle">Angle</label>
        <div class="range-min">-45</div>
        <input type="range" id="angle" min="-10" max="10" value="0" class="default-action">
        <div class="range-max">45</div>
      </div>
    </div>
    <div id="control-buttons">
      <table>
        <tr align="center">
          <td colspan="3"><button class="button rc-buttons" text-align="center" onmousedown="toggleCheckbox('forward');"
              ontouchstart="toggleCheckbox('forward');" onmouseup="toggleCheckbox('stop');"
              ontouchend="toggleCheckbox('stop');">&#x21E7</button></td>
        </tr>
        <tr align="center">
          <td><button class="button rc-buttons" text-align="center" onmousedown="toggleCheckbox('left');"
              ontouchstart="toggleCheckbox('left');" onmouseup="toggleCheckbox('stop');"
              ontouchend="toggleCheckbox('stop');">&#x21E6</button></td>
          <td align="center"><button class="button rc-buttons" onmousedown="toggleCheckbox('stop');"
              ontouchstart="toggleCheckbox('stop');">&#9632</button></td>
          <td align="center"><button class="button rc-buttons" onmousedown="toggleCheckbox('right');"
              ontouchstart="toggleCheckbox('right');" onmouseup="toggleCheckbox('stop');"
              ontouchend="toggleCheckbox('stop');">&#x21E8</button></td>
        </tr>
        <tr align="center">
          <td colspan="3"><button class="button rc-buttons" onmousedown="toggleCheckbox('backward');"
              ontouchstart="toggleCheckbox('backward');" onmouseup="toggleCheckbox('stop');"
              ontouchend="toggleCheckbox('stop');">&#x21E9</button></td>
        </tr>
      </table>
      <div class="joystick">
        <div id="base"><img id="stick" src="images/joystick-orange.png"/></div>
      </div>

      </div>
    </div>
  </div>

  <div id="settings" class="hidden">
    <div class="input-group" id="framesize-group">
      <label for="framesize">Resolution</label>
        <select id="framesize" class="default-action">
          <option value="0">QVGA(320x240)</option>
          <option value="1" selected="selected">VGA(640x480)</option>
          <option value="2">HD(1280x720)</option>
          <option value="3">FHD(1920x1080)</option>
          <option value="4" >QHD(2560x1440)</option>
      </select>
    </div>
    <div class="input-group" id="brightness-group">
      <label for="brightness">Brightness</label>
      <div class="range-min">-3</div>
      <input type="range" id="brightness" min="-3" max="3" value="0" class="default-action">
      <div class="range-max">3</div>
    </div>
    <div class="input-group" id="contrast-group">
      <label for="contrast">Contrast</label>
      <div class="range-min">-3</div>
      <input type="range" id="contrast" min="-3" max="3" value="0" class="default-action">
      <div class="range-max">3</div>
    </div>
    <div class="input-group" id="saturation-group">
      <label for="saturation">Saturation</label>
      <div class="range-min">-4</div>
      <input type="range" id="saturation" min="-4" max="4" value="0" class="default-action">
      <div class="range-max">4</div>
    </div>
    <div class="input-group" id="mode-group">
      <label for="mode">Vision Mode</label>
      <div class="switch">
        <label>Mobile</label>
        <input id="mode" type="checkbox" class="default-action">
        <label class="slider" for="mode"></label>
        <label>&nbsp;&nbsp;PC</label>
      </div>
    </div>
  </div>

  <div id="information" class="hidden">
    <div class="input-group">
      <div>Start video stream&nbsp;&nbsp;&nbsp;</div>
      <i class="bi-camera-video"></i>
    </div>
    <div class="input-group">
      <div>Take picture&nbsp;&nbsp;&nbsp;</div>
      <i class="bi-camera"></i>
    </div>
    <div class="input-group">
      <div>Ball tracking&nbsp;&nbsp;&nbsp;</div>
      <i class="bi-dribbble"></i>
    </div>
    <div class="input-group">
      <div>Sign detection&nbsp;&nbsp;&nbsp;</div>
      <i class="bi-stoplights"></i>
    </div>
    <div class="input-group">
      <div>Object detection&nbsp;&nbsp;&nbsp;</div>
      <i class="bi-bounding-box"></i>
    </div>
    <div class="input-group">
      <div>Face detection&nbsp;&nbsp;&nbsp;</div>
      <i class="bi-person-bounding-box"></i>
    </div>
    <div class="input-group">
      <div>Face enrollment&nbsp;&nbsp;&nbsp;</div>
      <i class="bi-person-plus"></i>
    </div>
    <div class="input-group">
      <div>Face recognition&nbsp;&nbsp;&nbsp;</div>
      <i class="bi-person-check"></i>
    </div>
    <div class="input-group">
      <div>Remote control&nbsp;&nbsp;&nbsp;</div>
      <i class="bi-controller"></i>
    </div>
    <div class="input-group">
      <div>Vision settings&nbsp;&nbsp;&nbsp;</div>
      <i class="bi-gear"></i>
    </div>
  </div>

  <figure>
    <div id="video-container" class="hidden">
      <a id="save-still" href="#" class="button save hidden" download="capture.jpg">Save</a>
      <div class="close" id="close-stream">×</div>
      <img id="video" src="//:0" crossorigin/>
      <canvas id="canvas"></canvas>
    </div>
  </figure>

</body>

  <!-- TensorFlow.js -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
  <!-- <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@^1.7.4"></script> -->

  <!-- Adds the CPU backend -->
  <!-- <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-cpu"></script> -->

  <!-- Import @tensorflow/tfjs-tflite for mobile devices -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-tflite/dist/tf-tflite.min.js"></script>

  <!-- Object detection model -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"> </script>

  <!-- Face detection, landmarks and recognition models -->
  <script src='models/face-api.js'></script>

  <script>

    class JoystickController
    {
      // stickID: ID of HTML element (representing joystick) that will be dragged
      // maxDistance: maximum amount joystick can move in any direction
      // deadzone: joystick must move at least this amount from origin to register value change
      constructor( stickID, maxDistance, deadzone )
      {
        this.id = stickID;
        let stick = document.getElementById("stick");

        // location from which drag begins, used to calculate offsets
        this.dragStart = null;

        // track touch identifier in case multiple joysticks present
        this.touchId = null;

        this.active = false;
        this.value = { x: 0, y: 0 };

        let self = this;

        function handleDown(event)
        {
            self.active = true;

          // all drag movements are instantaneous
          stick.style.transition = '0s';

          // touch event fired before mouse event; prevent redundant mouse event from firing
          event.preventDefault();

            if (event.changedTouches)
              self.dragStart = { x: event.changedTouches[0].clientX, y: event.changedTouches[0].clientY };
            else
              self.dragStart = { x: event.clientX, y: event.clientY };

          // if this is a touch event, keep track of which one
            if (event.changedTouches)
              self.touchId = event.changedTouches[0].identifier;
        }

        function handleMove(event)
        {
            if ( !self.active ) return;

            // if this is a touch event, make sure it is the right one
            // also handle multiple simultaneous touchmove events
            let touchmoveId = null;
            if (event.changedTouches)
            {
              for (let i = 0; i < event.changedTouches.length; i++)
              {
                if (self.touchId == event.changedTouches[i].identifier)
                {
                  touchmoveId = i;
                  event.clientX = event.changedTouches[i].clientX;
                  event.clientY = event.changedTouches[i].clientY;
                }
              }

              if (touchmoveId == null) return;
            }

            const xDiff = event.clientX - self.dragStart.x;
            const yDiff = event.clientY - self.dragStart.y;
            const angle = Math.atan2(yDiff, xDiff);
          const distance = Math.min(maxDistance, Math.hypot(xDiff, yDiff));
          const xPosition = distance * Math.cos(angle);
          const yPosition = distance * Math.sin(angle);

          // move stick image to new position
            stick.style.transform = `translate3d(${xPosition}px, ${yPosition}px, 0px)`;

          // deadzone adjustment
          const distance2 = (distance < deadzone) ? 0 : maxDistance / (maxDistance - deadzone) * (distance - deadzone);
            const xPosition2 = distance2 * Math.cos(angle);
          const yPosition2 = distance2 * Math.sin(angle);
            const xPercent = parseFloat((xPosition2 / maxDistance).toFixed(4));
            const yPercent = parseFloat((yPosition2 / maxDistance).toFixed(4));

            self.value = { x: xPercent, y: yPercent };
          }

        function handleUp(event)
        {
            if ( !self.active ) return;

            // if this is a touch event, make sure it is the right one
            if (event.changedTouches && self.touchId != event.changedTouches[0].identifier) return;

            // transition the joystick position back to center
            stick.style.transition = '.2s';
            stick.style.transform = `translate3d(0px, 0px, 0px)`;

            // reset everything
            self.value = { x: 0, y: 0 };
            self.touchId = null;
            self.active = false;
        }

        stick.addEventListener('mousedown', handleDown);
        stick.addEventListener('touchstart', handleDown);
        document.addEventListener('mousemove', handleMove, {passive: false});
        document.addEventListener('touchmove', handleMove, {passive: false});
        document.addEventListener('mouseup', handleUp);
        document.addEventListener('touchend', handleUp);
      }
    }

    let joystick1 = new JoystickController("stick1", 30, 8);

    function update(){
      console.log("Joystick 1: " + JSON.stringify(joystick1.value));
    }

    function loop(){
      requestAnimationFrame(loop);
      update();
    }

    // loop();

    </script>

  <script>

    // Buttons Test

    // function toggleCheckbox(x) {
    //   websocket.send(x);
    //   console.log(x);
    // }

    // function toggleCheckbox(x) {
    //   var xhr = new XMLHttpRequest();
    //   xhr.open("GET", "/action?go=" + x, true);
    //   xhr.send();
    // }

    // window.onload = document.getElementById("photo").src =     window.location.href.slice(0, -1) + ":81/stream";

    // var gateway = `ws://${window.location.hostname}/ws`;
    // var websocket;

    // window.addEventListener('load', initWebSocket);
    // function initWebSocket() {
    //   console.log('Trying to open a WebSocket connection...');
    //   websocket = new WebSocket(gateway);
    //   websocket.onopen = onOpen;
    //   websocket.onclose = onClose;
    //   websocket.onmessage = onMessage;
    // }
    // function onOpen(event) {
    //   console.log('Ws Connection opened');
    // }
    // function onClose(event) {
    //   console.log('Ws Connection closed');
    //   setTimeout(initWebSocket, 2000);
    // }
    // function onMessage(event) {
    //   console.log(event.data);
    // }

    // ESPWHO Code
    document.addEventListener('DOMContentLoaded', function (event) {
      var baseHost = document.location.origin
      var streamUrl = baseHost + ':81'
      function fetchUrl(url, cb) {
        fetch(url)
          .then(function (response) {
            if (response.status !== 200) {
              cb(response.status, response.statusText);
            } else {
              response.text().then(function (data) {
                cb(200, data);
              }).catch(function (err) {
                cb(-1, err);
              });
            }
          })
          .catch(function (err) {
            cb(-1, err);
          });
      }

      function setWindow(start_x, start_y, end_x, end_y, offset_x, offset_y, total_x, total_y, output_x, output_y, scaling, binning, cb) {
        fetchUrl(`${baseHost}/resolution?sx=${start_x}&sy=${start_y}&ex=${end_x}&ey=${end_y}&offx=${offset_x}&offy=${offset_y}&tx=${total_x}&ty=${total_y}&ox=${output_x}&oy=${output_y}&scale=${scaling}&binning=${binning}`, cb);
      }

      // switch(window.orientation){
      //   case -90: case 90: /* Device is in landscape mode */
      //       break;
      //   default:    /* Device is in portrait mode */
      //       window.orientation = window.orientation-90;
      //       break;
      // }

      // Check later
      const updateValue = (el, value, updateRemote) => {
        updateRemote = updateRemote == null ? true : updateRemote
        let initialValue
        if (el.type == 'checkbox') {
          initialValue = el.checked
          value = !!value
          el.checked = value
        } else {
          initialValue = el.value
          el.value = value
        }

        if (updateRemote && initialValue !== value) {
          updateConfig(el);
        } else if (!updateRemote) {
          if (el.id == "face-recog") {
            value ? enable(enrollButton) : disable(enrollButton)
          }
        }
      }

      function updateConfig(el) {
        let value
        switch (el.type) {
          case 'range':
          case 'select-one':
            value = el.value
            break
          default:
            return
        }

        const query = `${baseHost}/control?var=${el.id}&val=${value}`

        fetch(query)
          .then(response => {
            console.log(`request to ${query} finished, status: ${response.status}`)
          })
      }

      // Attach default on change action
      document
        .querySelectorAll('.default-action')
        .forEach(el => {
          el.onchange = () => updateConfig(el)
        })

      // Read initial values
      fetch(`${baseHost}/status`)
        .then(function (response) {
          return response.json()
        })
        .then(function (state) {
          document
            .querySelectorAll('.default-action')
            .forEach(el => {
              updateValue(el, state[el.id], false)
            })

        })

      const hide = el => {
        el.classList.add('hidden');
        el.hidden = true;
      }
      const show = el => {
        el.classList.remove('hidden');
        el.hidden = false;
      }
      const disable = el => {
        el.classList.add('disabled');
        el.disabled = true;
        el.style.background=('rgb(153, 153, 153)');
        switch (el) {
          case signdetButton:
            el.innerHTML = '<i class="bi-stoplights"></i>'
            break;
          case objdetButton:
            el.innerHTML = '<i class="bi-bounding-box"></i>'
            break;
          case facedetButton:
            el.innerHTML = '<i class="bi-person-bounding-box"></i>'
            break;
          case recogButton:
            el.innerHTML = '<i class="bi-person-check"></i>'
            break;
          case enrollButton:
            el.innerHTML = '<i class="bi-person-plus"></i>'
            break;
        }
      }
      const enable = el => {
        el.classList.remove('disabled');
        el.disabled = false;
        el.style.background=('rgb(57, 57, 57)');
      }
      const notPressed = el => {
        ctx.clearRect(0, 0, canvas.width, canvas.height)
        el.style.background=('rgb(57, 57, 57)');
        switch (el) {
          case streamButton:
            el.innerHTML = '<i class="bi-camera-video"></i>'
            break;
          case signdetButton:
            el.innerHTML = '<i class="bi-stoplights"></i>'
            break;
          case objdetButton:
            el.innerHTML = '<i class="bi-bounding-box"></i>'
            break;
          case facedetButton:
            el.innerHTML = '<i class="bi-person-bounding-box"></i>'
            break;
          case recogButton:
            el.innerHTML = '<i class="bi-person-check"></i>'
            break;
          case enrollButton:
            el.innerHTML = '<i class="bi-person-plus"></i>'
            break;
          case settingsButton:
            el.innerHTML = '<i class="bi-gear"></i>'
            break;
          case infoButton:
            el.innerHTML = '<i class="bi-info-circle"></i>'
            break;
        }
      }
      const pressed = el => {
        el.style.background=('rgb(87, 87, 87)');
        switch (el) {
          case streamButton:
            el.innerHTML = '<i class="bi-camera-video-off"></i>'
            break;
          case signdetButton:
            el.innerHTML = '<i class="bi-stoplights-fill"></i>'
            break;
          case objdetButton:
            el.innerHTML = '<i class="bi-check-square"></i>'
            break;
          case facedetButton:
            el.innerHTML = '<i class="bi-person-square"></i>'
            break;
          case recogButton:
            el.innerHTML = '<i class="bi-person-check-fill"></i>'
            break;
          case enrollButton:
            el.innerHTML = '<i class="bi-person-plus-fill"></i>'
            break;
          case settingsButton:
            el.innerHTML = '<i class="bi-gear-fill"></i>'
            break;
          case infoButton:
            el.innerHTML = '<i class="bi-info-circle-fill"></i>'
            break;
        }
      }

      const videoContainer = document.getElementById('video-container'),
            video = document.getElementById('video'),
            closeButton = document.getElementById('close-stream'),
            streamButton = document.getElementById('toggle-stream'),
            videoURL = "http://192.168.1.7:4747/video", //Droidcam
            // videoURL = "http://192.168.1.2:80/streaming", //ESP12K-OV5640
            canvas = document.getElementById('canvas'),
            ctx = canvas.getContext('2d'),
            stillButton = document.getElementById('get-still'),
            saveButton = document.getElementById('save-still'),
            ballButton = document.getElementById('ball-track'),
            signdetButton = document.getElementById('sign-detect'),
            objdetButton = document.getElementById('object-detect'),
            facedetButton = document.getElementById('face-detect'),
            load = document.getElementById('loading'),
            enrollButton = document.getElementById('face-add'),
            visionMode = document.getElementById('mode');

      window.onresize = function(){
        canvas.width = video.width;
        canvas.height = video.height;
        mx = 2560/video.width;
        my = 1920/video.height;
      }

      const stopStream = () => {
        window.stop();
        hide(videoContainer);
        notPressed(streamButton);
        disable(stillButton);
        disable(ballButton);
        disable(signdetButton);
        disable(objdetButton);
        disable(facedetButton);
        disable(recogButton);
        disable(enrollButton);
        hide(faceSettings);
        sleep(500).then(() => { ctx.clearRect(0, 0, canvas.width, canvas.height); });
      }

      const startStream = () => {
        console.log(video.src = videoURL);
          // if (IP == "") {
          //   IP = prompt("Please enter DeskPet's IP address", "");
          // }
          // if (checkIfValidIP(IP)) {   //CHANGE CONDITION
          //   let streamURL = "http://" + IP + ":4747/video";
          //   video.src = streamURL;
            show(videoContainer);
            pressed(streamButton);
            enable(stillButton);
            enable(ballButton);
            enable(signdetButton);
            enable(objdetButton);
            enable(facedetButton);
            enable(enrollButton);
            enable(recogButton);
            video.onload = function() {
              canvas.width = this.width;
              canvas.height = this.height;
              mx = 2560/video.width;
              my = 1920/video.height;
            }
          // } else {
          //   alert("Please enter a valid IP address");
          //   IP = "";
          // }
          ctx.clearRect(0, 0, canvas.width, canvas.height);
      }

      let IP = "";

      function checkIfValidIP(str) {
        const regexExp = /^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])$/gi;
        return regexExp.test(str);
      }

      streamButton.onclick = () => {
        if (streamButton.innerHTML == '<i class="bi-camera-video-off"></i>') {
          stopStream();
        }
        else {
          startStream();
        }
      }

      stillButton.onclick = () => {
        ctx.drawImage(video, 0, 0)
        show(videoContainer)
        show(saveButton)
      }

      saveButton.onclick = () => {
        try {
          var dataURL = canvas.toDataURL('image/jpeg');
          saveButton.href = dataURL;
          var d = new Date();
          saveButton.download = d.getFullYear() + ("0" + (d.getMonth() + 1)).slice(-2) + ("0" + d.getDate()).slice(-2) + ("0" + d.getHours()).slice(-2) + ("0" + d.getMinutes()).slice(-2) + ("0" + d.getSeconds()).slice(-2) + ".jpg";
        } catch (e) {
          console.error(e);
        }
        hide(saveButton);
        stopStream();
        sleep(1000).then(() => { startStream() });
      }

      closeButton.onclick = () => {
        stopStream();
        hide(videoContainer);
        hide(saveButton)
      }

      function sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
      }

      function buildDetections(scores, boxes, classes, classesDir, thresh) {
        const detectionObjects = [];

        scores[0].forEach((score, i) => {
          if (score >= thresh) {
            const bbox = [];
            const minY = boxes[0][i][0] * video.height;
            const minX = boxes[0][i][1] * video.width;
            const maxY = boxes[0][i][2] * video.height;
            const maxX = boxes[0][i][3] * video.width;
            bbox[0] = minX;
            bbox[1] = minY;
            bbox[2] = maxX - minX;
            bbox[3] = maxY - minY;
            if (classesDir == classesCoco) {
              labelid = classesDir[classes[i]+1].name;
            }
            else{
              labelid = classesDir[classes[i]].name;
            }
            detectionObjects.push({
              class: classes[i],
              label: labelid,
              score: score,
              bbox: bbox
            })
            // ctx.fillText(classesDir[classes[i]].name,video.width/2,video.height/2);
          }
        })
        return detectionObjects
      }

      function printDetections(score, thresh, bbox, label){
        if (score >= thresh){
        ctx.strokeStyle = 'white';
        ctx.font = "17px Helvetica";
        ctx.fillStyle = "white";
        ctx.strokeRect(bbox[0],bbox[1],bbox[2],bbox[3]);
        ctx.fillText(label,bbox[0]+5,bbox[1]+15);
        ctx.fillText(score.toFixed(2),bbox[0]+bbox[2]-35,bbox[1]+15);
        }
      }
      var visionFlag = 0,
          speed = 0;

      async function checkLoaded(el){
        if (video.complete && video.naturalHeight !== 0){
          console.log(el);
          disable(ballButton);
          disable(signdetButton);
          disable(objdetButton);
          disable(enrollButton);
          disable(facedetButton);
          disable(recogButton);
          flag = true;
        } else{
          alert("Video has no loaded yet")
          flag = false;
        }
        if (visionFlag == 0){
          await checkInfSpeed();
          visionFlag = 1;
        }
        return flag;
      }

      visionMode.onchange = () => {
        faceapiFlag = 0;
        signDetmodel = undefined;
        if (visionMode.checked){
          console.log("Changed to PC Mode");
          speed = 1;
        }
        else{
          console.log("Changed to Mobile Mode");
          speed = 0;
        }
      }

      async function checkInfSpeed(){
        if (visionFlag == 0){
          let sum = 0;
          for (let i = 0; i <= 10; i++){
            performance.mark('mark1');
            await objdetButtonFunc();
            performance.mark('mark2');
            performance.measure('markMeasure', 'mark1', 'mark2');
            if (i > 2){
              sum = sum + performance.getEntriesByName('markMeasure')[i].duration;
            }
          }
          mean = sum/8;
          console.log("Inference speed (ms): " + mean.toFixed(1));
          ctx.font = "17px Helvetica";
          // ctx.fillText(mean.toString(),video.width-40,video.height-40);
          if (mean <= 150){
            speed = 1;
            visionMode.checked="checked";
            console.log("Default vision mode: PC");
          }
          else{
            console.log("Default vision mode: Mobile");
          }
        }
      }

      function printOnScreen(text, fontFace, maxWidth) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.font = `1px ${fontFace}`;
        size = maxWidth / ctx.measureText(text).width;
        ctx.font = (size/2).toString() + 'px Helvetica';
        ctx.fillStyle = "white";
        ctx.fillText(text,video.width/3.7,video.height/2);
      }

      // BALL TRACKING
      var ballModel0,
          ballModel1,
          ballxArray = [],
          ballyArray = [],
          balldistArray = [];

      function drawCircle(ctx, x, y, radius, fill, stroke, strokeWidth) {
        ctx.beginPath();
        ctx.arc(x, y, radius, 0, 2 * Math.PI, false)
        if (fill) {
          ctx.fillStyle = fill;
          ctx.fill();
        }
        if (stroke) {
          ctx.lineWidth = strokeWidth;
          ctx.strokeStyle = stroke;
          ctx.stroke();
        }
      }

      var  mx = 2560/640,
           my = 1920/480;

      function getAngles(u,v,radiusPX,type){
        // Binning (change in resolution)
        const fx = 2394.278;
        const fy = 2499.953;
        const cx = 1344.899;
        const cy = 885.970;
        // // Droidcam
        // const fx = 472.847;
        // const fy = 475.678;
        // const cx = 319.386;
        // const cy = 239.055;
        x = (u * mx - cx) / fx;
        y = (v * my - cy) / fy;
        thetaX = Math.atan(x) * 180 / Math.PI;
        thetaY = Math.atan(y) * 180 / Math.PI;
        if (type == "ball"){
          realRadius = 33.44; // Tennis ball
          radiusMM = radiusPX / ((fx + fy) / (mx + my));
          distance = realRadius / radiusMM;
        }
        else{
          distance = 0;
        }
        return {
          thetaX,
          thetaY,
          distance
        };
      }

      let classBall = {
        1: {
          id: 1,
          name: "sports ball",
        }
      };

      async function ballTracking() {
        var predictions;
        if (speed == 0){
          if (ballModel0 == undefined){
            printOnScreen("Please wait until the lite model loads","Helvetica",canvas.width);
            ballModel0 = await tf.loadGraphModel("/models/new/sports_ball_128_f16/model.json");
          }
          const t0 = performance.now();
          tf.engine().startScope();
          tfimg = tf.browser.fromPixels(video).toInt();
          const expandedimg = tfimg.expandDims();
          const detections = await ballModel0.executeAsync(expandedimg);
          // console.log(detections);
          const boxes = detections[3].arraySync();//output_3
          const scores = detections[1].arraySync();//Identity_1.0
          const classes = detections[5].dataSync();//Identity_2.0
          tf.engine().endScope();
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          predictions = buildDetections(scores, boxes, classes, classBall, 0.6);
          const t1 = performance.now();
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          ctx.fillStyle = "white";
          ctx.fillText((t1 - t0).toFixed(0).toString() + " fps",video.width-70,video.height-10);
        }
        else{
          if (ballModel1 == undefined){
            printOnScreen("Please wait until the full model loads","Helvetica",canvas.width)
            ballModel1 = await cocoSsd.load({base: 'mobilenet_v1'});
          }
          const t0 = performance.now();
          tf.engine().startScope();
          predictions = await ballModel1.detect(video, 5, 0.5);
          tf.engine().endScope();
          const t1 = performance.now();
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          ctx.fillStyle = "white";
          ctx.fillText((t1 - t0).toFixed(0).toString() + " fps",video.width-70,video.height-10);
        }
        ballxArray = [];
        ballyArray = [];
        balldistArray = [];
        for (i in predictions) {
          if (predictions[i].class == "sports ball" || predictions[i].label == "sports ball") {
            // console.log(predictions[i].score);
            radius = (predictions[i].bbox[2] + predictions[i].bbox[3])/4;
            x = predictions[i].bbox[0] + predictions[i].bbox[2]/2;
            y = predictions[i].bbox[1] + predictions[i].bbox[3]/2;
            drawCircle(ctx, x, y, radius, 0, 'blue', 3);
            ctx.font = (size/2).toString() + 'px Helvetica';
            ctx.fillStyle = "blue";
            let ball = getAngles(x,y,radius,"ball");
            ballxArray.push(ball.thetaX.toFixed(1));
            ballyArray.push(ball.thetaY.toFixed(1));
            balldistArray.push((ball.distance/10).toFixed(1));
          }
        }
        if (balldistArray.length != 0){
          var closest = balldistArray.reduce(function(lowestIndex, element, index, array){
                return element < array[lowestIndex] ? index : lowestIndex;
          }, 0);
          // For testing
          fx = "x: " + ballxArray[closest].toString() + "°";
          fy = "y: " + ballyArray[closest].toString() + "°";
          distance = "dist: " + balldistArray[closest].toString() + "cm";
          ctx.fillText(fx,predictions[closest].bbox[0]+predictions[closest].bbox[2]+10,predictions[closest].bbox[1]+predictions[closest].bbox[3]/2);
          ctx.fillText(fy,predictions[closest].bbox[0]+predictions[closest].bbox[2]/2-10,predictions[closest].bbox[1]-10);
          ctx.fillText(distance,predictions[closest].bbox[0]+predictions[closest].bbox[2]/2-10,predictions[closest].bbox[1]+predictions[closest].bbox[3]+20);
        }
        if (ballButton.style.background == ('rgb(87, 87, 87)')){
          sleep(50).then(() => { ballTracking(); });
        }
      }

      //TFLITE
      // var flagtst = 0;

      // async function ballTracking() {
      //   if (flagtst == 0){
      //     printOnScreen("Please wait until the model loads","Helvetica",canvas.width)
      //     ballModel = await tflite.loadTFLiteModel('models/ssd_mobilenet_v3.tflite');
      //     flagtst = 1;
      //   }
      //   const t0 = performance.now();
      //   tf.engine().startScope();
      //   const img = tf.browser.fromPixels(video).resizeBilinear([320,320]).toInt();
      //   const input = img.expandDims();
      //   let outputTensor = await ballModel.predict(input);
      //   console.log(outputTensor);
      //   const boxes = outputTensor['TFLite_Detection_PostProcess'].arraySync();
      //   const classes = outputTensor['TFLite_Detection_PostProcess:1'].dataSync();
      //   const scores = outputTensor['TFLite_Detection_PostProcess:2'].arraySync();
      //   // const boxes = outputTensor['StatefulPartitionedCall:3'].arraySync();
      //   // const classes = outputTensor['StatefulPartitionedCall:2'].dataSync();
      //   // const scores = outputTensor['StatefulPartitionedCall:1'].arraySync();
      //   tf.engine().endScope();
      //   const t1 = performance.now();
      //   ctx.clearRect(0, 0, canvas.width, canvas.height);
      //   ctx.fillText((t1 - t0).toFixed(1).toString(),video.width-50,video.height-10);
      //   const detections = buildDetections(scores, boxes, classes, classesCoco, 0.7);
      //   for (i in detections) {
      //     printDetections(detections[i].score, 0.6, detections[i].bbox, detections[i].label);
      //   }
      //   if (ballButton.style.background == ('rgb(87, 87, 87)')){
      //     sleep(50).then(() => { ballTracking(); });
      //   }
      // }

      ballButton.onclick = () => {
        if (ballButton.style.background == ('rgb(57, 57, 57)')) {
          checkLoaded("Ball tracking enabled").then((flag) => {
          switch (flag){
            case true:
              enable(ballButton);
              pressed(ballButton);
              ballTracking();
              break;
            case false:
              break;
            }
          });
        }else {
          enable(objdetButton);
          enable(signdetButton);
          enable(facedetButton);
          enable(enrollButton);
          enable(recogButton);
          notPressed(ballButton);
          sleep(500).then(() => { ctx.clearRect(0, 0, canvas.width, canvas.height); });
        }
      }

      // SIGN DETECTION
      var signDetmodel;

      let classesSign = {
        1: {
          name: 'Stop',
          id: 1,
        },
        2: {
          name: 'Right',
          id: 2,
        },
        3: {
          name: 'Left',
          id: 3,
        },
        4: {
          name: 'Up',
          id: 4,
        },
        5: {
          name: 'Down',
          id: 5,
        },
        6: {
          name: 'Forward',
          id: 6,
        },
        7: {
          name: 'Backward',
          id: 7,
        }
      };

      async function signdetButtonFunc() {
        if (signDetmodel == undefined){
          if (speed == 0){
            modelName = "/models/lite/sign_center_160_f16/model.json";
            box = 0;
            score = 2;
            classn = 3;
            thresh = 0.55;
            printOnScreen("Please wait until the lite model loads","Helvetica",canvas.width);
          }
          else {
            modelName = "/models/full/sign_mobile_320_f16/model.json";
            box = 0;
            score = 7;
            classn = 5;
            thresh = 0.75;
            printOnScreen("Please wait until the full model loads","Helvetica",canvas.width);
          }
          signDetmodel = await tf.loadGraphModel(modelName);
        }
        // console.log(signDetmodel.outputNodes);
        const t0 = performance.now();
        tf.engine().startScope();
        const tfimg = tf.browser.fromPixels(video).toInt();
        const expandedimg = tfimg.expandDims();
        const predictions = await signDetmodel.executeAsync(expandedimg);
        const boxes = predictions[box].arraySync();//Identity:0
        const scores = predictions[score].arraySync();//Identity_4.0
        const classes = predictions[classn].dataSync();//Identity_2.0
        tf.engine().endScope();
        const t1 = performance.now();
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.fillText((t1 - t0).toFixed(0).toString() + " fps",video.width-70,video.height-10);
        const detections = buildDetections(scores, boxes, classes, classesSign, thresh);
        // For testing
        for (i in detections) {
          printDetections(detections[i].score, 0.6, detections[i].bbox, detections[i].label);
        }
        if (signdetButton.innerHTML == '<i class="bi-stoplights-fill"></i>'){
          sleep(50).then(() => { signdetButtonFunc(); });
        }
      }

      signdetButton.onclick = () => {
        if (signdetButton.innerHTML == '<i class="bi-stoplights"></i>') {
          checkLoaded("Sign detection enabled").then((flag) => {
          switch (flag){
            case true:
              enable(signdetButton);
              pressed(signdetButton);
              signdetButtonFunc();
              break;
            case false:
              break;
          }
          });
        } else {
          enable(ballButton);
          enable(objdetButton);
          enable(facedetButton);
          enable(enrollButton);
          enable(recogButton);
          notPressed(signdetButton);
          sleep(500).then(() => { ctx.clearRect(0, 0, canvas.width, canvas.height); });
        }
      }

      // OBJECT DETECTION
      var objDetmodel0,
          objDetmodel1;

      let classesCoco = {
        1: {
          id: 1,
          name: 'person',
        },
        2: {
          id: 2,
          name: 'bicycle',
        },
        3: {
          id: 3,
          name: 'car',
        },
        4: {
          id: 4,
          name: 'motorcycle',
        },
        5: {
          id: 5,
          name: 'airplane',
        },
        6: {
          id: 6,
          name: 'bus',
        },
        7: {
          id: 7,
          name: 'train',
        },
        8: {
          id: 8,
          name: 'truck',
        },
        9: {
          id: 9,
          name: 'boat',
        },
        10: {
          id: 10,
          name: 'traffic light',
        },
        11: {
          id: 11,
          name: 'fire hydrant',
        },
        13: {
          id: 13,
          name: 'stop sign',
        },
        14: {
          id: 14,
          name: 'parking meter',
        },
        15: {
          id: 15,
          name: 'bench',
        },
        16: {
          id: 16,
          name: 'bird',
        },
        17: {
          id: 17,
          name: 'cat',
        },
        18: {
          id: 18,
          name: 'dog',
        },
        19: {
          id: 19,
          name: 'horse',
        },
        20: {
          id: 20,
          name: 'sheep',
        },
        21: {
          id: 21,
          name: 'cow',
        },
        22: {
          id: 22,
          name: 'elephant',
        },
        23: {
          id: 23,
          name: 'bear',
        },
        24: {
          id: 24,
          name: 'zebra',
        },
        25: {
          id: 25,
          name: 'giraffe',
        },
        27: {
          id: 27,
          name: 'backpack',
        },
        28: {
          id: 28,
          name: 'umbrella',
        },
        31: {
          id: 31,
          name: 'handbag',
        },
        32: {
          id: 32,
          name: 'tie',
        },
        33: {
          id: 33,
          name: 'suitcase',
        },
        34: {
          id: 34,
          name: 'frisbee',
        },
        35: {
          id: 35,
          name: 'skis',
        },
        36: {
          id: 36,
          name: 'snowboard',
        },
        37: {
          id: 37,
          name: 'sports ball',
        },
        38: {
          id: 38,
          name: 'kite',
        },
        39: {
          id: 39,
          name: 'baseball bat',
        },
        40: {
          id: 40,
          name: 'baseball glove',
        },
        41: {
          id: 41,
          name: 'skateboard',
        },
        42: {
          id: 42,
          name: 'surfboard',
        },
        43: {
          id: 43,
          name: 'tennis racket',
        },
        44: {
          id: 44,
          name: 'bottle',
        },
        46: {
          id: 46,
          name: 'wine glass',
        },
        47: {
          id: 47,
          name: 'cup',
        },
        48: {
          id: 48,
          name: 'fork',
        },
        49: {
          id: 49,
          name: 'knife',
        },
        50: {
          id: 50,
          name: 'spoon',
        },
        51: {
          id: 51,
          name: 'bowl',
        },
        52: {
          id: 52,
          name: 'banana',
        },
        53: {
          id: 53,
          name: 'apple',
        },
        54: {
          id: 54,
          name: 'sandwich',
        },
        55: {
          id: 55,
          name: 'orange',
        },
        56: {
          id: 56,
          name: 'broccoli',
        },
        57: {
          id: 57,
          name: 'carrot',
        },
        58: {
          id: 58,
          name: 'hot dog',
        },
        59: {
          id: 59,
          name: 'pizza',
        },
        60: {
          id: 60,
          name: 'donut',
        },
        61: {
          id: 61,
          name: 'cake',
        },
        62: {
          id: 62,
          name: 'chair',
        },
        63: {
          id: 63,
          name: 'couch',
        },
        64: {
          id: 64,
          name: 'potted plant',
        },
        65: {
          id: 65,
          name: 'bed',
        },
        67: {
          id: 67,
          name: 'dining table',
        },
        70: {
          id: 70,
          name: 'toilet',
        },
        72: {
          id: 72,
          name: 'tv',
        },
        73: {
          id: 73,
          name: 'laptop',
        },
        74: {
          id: 74,
          name: 'mouse',
        },
        75: {
          id: 75,
          name: 'remote',
        },
        76: {
          id: 76,
          name: 'keyboard',
        },
        77: {
          id: 77,
          name: 'cell phone',
        },
        78: {
          id: 78,
          name: 'microwave',
        },
        79: {
          id: 79,
          name: 'oven',
        },
        80: {
          id: 80,
          name: 'toaster',
        },
        81: {
          id: 81,
          name: 'sink',
        },
        82: {
          id: 82,
          name: 'refrigerator',
        },
        84: {
          id: 84,
          name: 'book',
        },
        85: {
          id: 85,
          name: 'clock',
        },
        86: {
          id: 86,
          name: 'vase',
        },
        87: {
          id: 87,
          name: 'scissors',
        },
        88: {
          id: 88,
          name: 'teddy bear',
        },
        89: {
          id: 89,
          name: 'hair drier',
        },
        90: {
          id: 90,
          name: 'toothbrush',
        }
      };

      async function objdetButtonFunc() {
        if (speed == 0){
          if (objDetmodel0 == null){
            printOnScreen("Please wait until the lite model loads","Helvetica",canvas.width);
            objDetmodel0 = await tflite.loadTFLiteModel('models/lite/ssd_mobilenet_v3.tflite');
            console.log("Loaded lite model");

          }
          const t0 = performance.now();
          tf.engine().startScope();
          const img = tf.browser.fromPixels(video).resizeBilinear([320,320]).toInt().expandDims();
          const outputTensor = await objDetmodel0.predict(img);
          const boxes = await outputTensor['TFLite_Detection_PostProcess'].arraySync();
          const classes = await outputTensor['TFLite_Detection_PostProcess:1'].dataSync();
          const scores = await outputTensor['TFLite_Detection_PostProcess:2'].arraySync();
          const detections = buildDetections(scores, boxes, classes, classesCoco, 0.5);
          tf.engine().endScope();
          const t1 = performance.now();
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          ctx.fillText((t1 - t0).toFixed(1).toString(),video.width-50,video.height-10);
          for (i in detections) {
            printDetections(detections[i].score, 0.6, detections[i].bbox, detections[i].label);
          }
        }
        else{
          if (objDetmodel1 == null){
            printOnScreen("Please wait until the full model loads","Helvetica",canvas.width)
            objDetmodel1 = await cocoSsd.load();
            console.log("Loaded full model");
          }
          const t0 = performance.now();
          tf.engine().startScope();
          const detections = await objDetmodel1.detect(video, 5, 0.6);
          tf.engine().endScope();
          const t1 = performance.now();
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          ctx.fillText((t1 - t0).toFixed(1).toString(),video.width-50,video.height-10);
          for (i in detections) {
            printDetections(detections[i].score, 0.7, detections[i].bbox, detections[i].class);
          }
        }
        if (objdetButton.innerHTML == '<i class="bi-check-square"></i>'){
          sleep(50).then(() => { objdetButtonFunc(); });
        }
      }

      objdetButton.onclick = () => {
        if (objdetButton.innerHTML == '<i class="bi-bounding-box"></i>') {
          checkLoaded("Object detection enabled").then((flag) => {
          switch (flag){
            case true:
              enable(objdetButton);
              pressed(objdetButton);
              objdetButtonFunc();
              break;
            case false:
              break;
          }
          });
        } else {
          enable(ballButton);
          enable(signdetButton);
          enable(facedetButton);
          enable(enrollButton);
          enable(recogButton);
          notPressed(objdetButton);
          sleep(500).then(() => { ctx.clearRect(0, 0, canvas.width, canvas.height); });
        }
      }

      const rcButton = document.getElementById('rc-control'),
            settings = document.getElementById('settings'),
            settingsButton = document.getElementById('cam-settings'),
            framesize = document.getElementById('framesize'),
            infoButton = document.getElementById('info'),
            faceSettings = document.getElementById('face-settings'),
            recogButton = document.getElementById('face-recog'),
            saveIDButton = document.getElementById('save-id');

      // FACE DETECTION
      var faceDetmodel0 = 0,
          faceDetmodel1 = 0;

      async function detectFaceFunc() {
        if (speed == 0){
          if (faceDetmodel0 == 0){
            printOnScreen("Please wait until the lite model loads","Helvetica",canvas.width);
            await faceapi.nets.tinyFaceDetector.loadFromUri('/models/lite/face_detector');
            faceDetmodel0 = 1;
            console.log("Loaded lite model");
          }
          model = new faceapi.TinyFaceDetectorOptions({ inputSize: 224 });
        }
        else {
          if (faceDetmodel1 == 0){
            printOnScreen("Please wait until the full model loads","Helvetica",canvas.width);
            await faceapi.nets.ssdMobilenetv1.loadFromUri('/models/full/face_detector');
            faceDetmodel1 = 1;
            console.log("Loaded full model");
          }
          model = new faceapi.SsdMobilenetv1Options();
        }
        const t0 = performance.now();
        var results = await faceapi.detectAllFaces(video, model);
        const t1 = performance.now();
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.fillText((t1 - t0).toFixed(0).toString() + " fps",video.width-70,video.height-10);
        if (results != null){
          const predictions = faceapi.resizeResults(results, { width: video.width, height: video.height })
          for (i in predictions) {
            var bbox = [];
            bbox = [predictions[i].box.x, predictions[i]._box.y, predictions[i].box.width, predictions[i].box.height];
            printDetections(predictions[i].score, 0.6, bbox, "");
            if (predictions[i].score > 0.6){
              fx = predictions[i].box.x + predictions[i].box.width/2;
              fy = predictions[i].box.y + predictions[i].box.height/2;
              let angles = getAngles(fx,fy,0,"face");
              console.log("x: " + (angles.thetaX.toFixed(1)).toString() + "°");
              console.log("y: " + (angles.thetaY.toFixed(1)).toString() + "°");
            }
          }
        }
        if (facedetButton.innerHTML == '<i class="bi-person-square"></i>'){
          sleep(50).then(() => { detectFaceFunc(); });
        }
      }

      facedetButton.onclick = () => {
        if (facedetButton.innerHTML == '<i class="bi-person-bounding-box"></i>') {
          checkLoaded("Face detection enabled").then((flag) => {
          switch (flag){
            case true:
              enable(facedetButton);
              pressed(facedetButton);
              detectFaceFunc();
              break;
            case false:
              break;
          }
          });
        } else {
          enable(ballButton);
          enable(signdetButton);
          enable(objdetButton);
          enable(enrollButton);
          enable(recogButton);
          hide(faceSettings);
          notPressed(facedetButton);
          sleep(500).then(() => { ctx.clearRect(0, 0, canvas.width, canvas.height); });
        }
      }

      var faceMatcher,
          labeledDescriptors = [],
          faceapiFlag = 0,
          i = 0,
          html = "",
          name = "";

      // FACE ID
      enrollButton.onclick = () => {
        const enrollEnabled = enrollButton.innerHTML == '<i class="bi-person-plus"></i>';
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        if (enrollEnabled) {
          if (faceapiFlag == 0){
            loadFaceapiModels();
          }
          checkLoaded("Face enrollment enabled").then((flag) => {
            switch (flag){
              case true:
                show(faceSettings);
                enable(enrollButton);
                pressed(enrollButton);
                hide(settings);
                notPressed(settingsButton);
                hide(information);
                notPressed(infoButton);
                break;
              case false:
                break;
            }
          });
        }else {
          enable(ballButton);
          enable(signdetButton);
          enable(objdetButton);
          enable(facedetButton);
          enable(recogButton);
          notPressed(enrollButton);
          hide(faceSettings);
          }
      }

      async function loadFaceapiModels(){
        if (speed == 0){
          printOnScreen("Please wait until the lite models load","Helvetica",canvas.width);
          if (faceDetmodel0 == 0){ //https://raw.githubusercontent.com/geraldinebc/test/master/models/
            await faceapi.nets.tinyFaceDetector.loadFromUri('/models/lite/face_detector');
            faceDetmodel0 = 1;
          }
          await faceapi.nets.faceLandmark68TinyNet.loadFromUri('/models/lite/face_landmark');
          console.log("Loaded lite models");
        }
        else{
          printOnScreen("Please wait until the full models load","Helvetica",canvas.width);
          if (faceDetmodel1 == 0){
            await faceapi.nets.ssdMobilenetv1.loadFromUri('/models/full/face_detector');
            faceDetmodel1 = 1;
          }
          await faceapi.nets.faceLandmark68Net.loadFromUri('/models/full/face_landmark');
          console.log("Loaded full models");
        }
        await faceapi.nets.faceRecognitionNet.loadFromUri('/models/full/face_recognition');
        faceapiFlag = 1;
      }

      reply_click = function(clicked_id){
        IDname = document.getElementById(("delete-" + clicked_id)).textContent;
        document.getElementById(("delete-" + clicked_id)).remove();
        document.getElementById((clicked_id)).remove();

        function IDindex(o) {
          return o.label == IDname;
        }

        let numID = labeledDescriptors.findIndex(IDindex);
        labeledDescriptors.splice(numID,1);
        console.log(labeledDescriptors);
        if (i == 1){
          faceMatcher = undefined;
        }
        else{
          faceMatcher = new faceapi.FaceMatcher(labeledDescriptors);
        }
        i--;
      }

      async function saveFaceFunc() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        if (speed == 0){
          model = new faceapi.TinyFaceDetectorOptions({ inputSize: 224 });
          landmark = true;
        }
        else {
          model = new faceapi.SsdMobilenetv1Options();
          landmark = false;
        }
        const detection = await faceapi.detectSingleFace(video, model).withFaceLandmarks(landmark).withFaceDescriptor();
        enable(saveIDButton);
        saveIDButton.style.background = ('rgb(254, 175, 60)');

        if (!detection) {
          alert("No faces found")
        }
        else {
          let ID = labeledDescriptors.find(o => o.label == name);
          const prediction = faceapi.resizeResults(detection, { width: video.width, height: video.height });
          bbox = [prediction.detection._box._x, prediction.detection._box._y, prediction.detection._box._width, prediction.detection._box._height];
          printDetections(prediction.detection.score, 0.7, bbox, name);

          if (ID){
            if (ID.descriptors.length <= 5){
              ID.descriptors.push(detection.descriptor);
            }
            else{
              alert("You have reached the maximum number of views allowed");
            }
          }
          else{
            i++;
            if (i <= 6){
            labeledDescriptors.push(new faceapi.LabeledFaceDescriptors(String(name),[detection.descriptor]));
            html += "<div class=\"input-group\"><label id=\"delete-id" + i + "\">" + name + "</label>";
            html += "<button class=\"button inline-button\" onClick=\"reply_click(this.id)\" id=\"id" + i;
            html += "\"><i class=\"bi-trash\"></i></button></div>";
            document.getElementById('face-ID').innerHTML += html;
            html = "";
            }
            else{
              alert("You have reached the maximum number of face IDs allowed");
            }
          }
          faceMatcher = new faceapi.FaceMatcher(labeledDescriptors);
          sleep(1500).then(() => { ctx.clearRect(0, 0, canvas.width, canvas.height); });
        }
      }

      saveIDButton.onclick = () => {
        name = document.getElementById('fname').value
        if (name == ""){
          alert("Please enter an ID name");
        }
        else{
          disable(saveIDButton);
          if (faceapiFlag == 0){
            loadFaceapiModels();
          }
          saveFaceFunc();
        }
      }

      // FACE RECOGNITION
      var startFaceRec;

      async function recogFaceFunc() {
        if (faceMatcher == undefined){
          enable(ballButton);
          enable(signdetButton);
          enable(objdetButton);
          enable(facedetButton);
          enable(enrollButton);
          notPressed(recogButton);
          alert("Please add a face ID to enable face recognition");
        }
        else if (speed == 0){
          model = new faceapi.TinyFaceDetectorOptions({ inputSize: 224 });
          landmark = true;
        }
        else {
          model = new faceapi.SsdMobilenetv1Options();
          landmark = false;
        }
        const t0 = performance.now();
        const results = await faceapi.detectAllFaces(video, model).withFaceLandmarks(landmark).withFaceDescriptors();
        const t1 = performance.now();
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.fillText((t1 - t0).toFixed(0).toString() + " fps",video.width-70,video.height-10);
        const detection = faceapi.resizeResults(results, { width: video.width, height: video.height });
        detection.forEach(fd => {
          const bestMatch = faceMatcher.findBestMatch(fd.descriptor);
          bbox = [fd.detection._box._x, fd.detection._box._y, fd.detection._box._width, fd.detection._box._height];
          printDetections(1-bestMatch.distance, 0.5, bbox, bestMatch.label.toString());
        })
        if (recogButton.innerHTML == '<i class="bi-person-check-fill"></i>'){
          sleep(50).then(() => { recogFaceFunc(); });
        }
      }

      recogButton.onclick = () => {
        if (recogButton.innerHTML == '<i class="bi-person-check"></i>') {
          checkLoaded("Face recognition enabled").then((flag) => {
          switch (flag){
            case true:
              enable(recogButton);
              pressed(recogButton);
              recogFaceFunc();
              break;
            case false:
              break;
          }
          });
        }else {
          enable(ballButton);
          enable(signdetButton);
          enable(objdetButton);
          enable(facedetButton);
          enable(enrollButton);
          notPressed(recogButton);
          sleep(500).then(() => { ctx.clearRect(0, 0, canvas.width, canvas.height); });
        }
      }

      const controlBox = document.getElementById('control-box')

      rcButton.onclick = () => {
        if (rcButton.style.background == 'rgb(87, 87, 87)') {
          notPressed(rcButton);
          hide(controlBox);
        }
        else {
          pressed(rcButton);
          show(controlBox);
          hide(settings);
          notPressed(settingsButton);
          hide(information);
          notPressed(infoButton);
        }
      }

      settingsButton.onclick = () => {
        if (settingsButton.innerHTML == '<i class="bi-gear"></i>') {
          pressed(settingsButton);
          show(settings);
          notPressed(rcButton);
          hide(controlBox);
          enrollButton.innerHTML = '<i class="bi-person-plus"></i>'
          hide(faceSettings);
          notPressed(infoButton);
          hide(information);
        }
        else {
          notPressed(settingsButton);
          hide(settings);
        }
      }

      infoButton.onclick = () => {
        if (infoButton.innerHTML == '<i class="bi-info-circle"></i>') {
          pressed(infoButton);
          show(information);
          enrollButton.innerHTML = '<i class="bi-person-plus"></i>'
          hide(faceSettings);
          notPressed(rcButton);
          hide(controlBox);
          notPressed(settingsButton);
          hide(settings);
        }
        else {
          notPressed(infoButton);
          hide(information);
        }
      }

      framesize.onchange = () => {
        updateConfig(framesize.value)
      }
    })
  </script>

</html>