<!doctype html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="manifest" href="manifest.json">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css">
  <title>DESKPET</title>
  <style>

    body {
      font-family: Helvetica;
      background: #181818;
      color: #EFEFEF;
      font-size: 16px;
      margin: 0
    }

    #header-top {
      background-color: #393939;
      height: 65px;
    }

    #lynx-logo{
      position: absolute;
      top: 0;
      padding: 20px 12px;
      height: 90px;
    }

    #deskpet {
      position: absolute;
      top: 5px;
      right: 5px;
      font-size: 30px;
      font-weight: bold;
      padding: 10px;
    }

    #nav-bar {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      background-color: #feaf3c;
      min-height: 40px;
    }

    .trapezoid {
      border-top: 60px solid #393939;
      border-right: 60px solid transparent;
      min-width: 220px;
    }

    #nav-space{
      flex-grow: 1;
    }

    .nav-icons {
      background: #393939;
      color: #fff;
      font-size: 20px;
      margin: 5px;
      padding: 5px;
      border: 0;
      cursor: pointer;
    }

    .button {
      margin: 5px;
      padding: 0 12px;
      border: 0;
      cursor: pointer;
      color: #fff;
      background: #feaf3c;
      border-radius: 5px;
      font-size: 20px;
      outline: none;
      box-shadow: 0 5px #999;
    }

    .button:hover {
      background-color: #fe933c;
    }

    .button:active {
      background-color: #fe933c;
      box-shadow: 0 2px #999;
      transform: translateY(4px);
    }

    button.disabled {
      cursor: default;
      background: #999
    }

    #settings {
      position: absolute;
      right: 0;
      padding: 10px
    }

    input.toggle-section-button:checked+section.toggle-section {
      display: none
    }

    #control-box {
      position: absolute;
      top: 40%;
      right: 0;
      padding: 20px 10px
    }
    
    .rc-buttons {
      font-weight: bold;
      display: flex;
      justify-content: center;
      align-items: center;
      border-radius: 50%;
      font-size: 20px;
      width: 35px;
      height: 35px
    }

    .hidden {
      display: none
    }

    .input-group {
      display: flex;
      flex-wrap: nowrap;
      justify-content: space-between;
      line-height: 22px;
      margin: 5px
    }

    .input-group>label {
      display: inline-block;
      padding-bottom: 10px;
      min-width: 40%
    }

    .range-max, .range-min {
      display: inline-block;
      padding: 0 5px
    }

    input[type=range] {
      -webkit-appearance: none;
      width: 100%;
      height: 22px;
      background: rgba(51, 51, 54, 0.3);
      cursor: pointer;
      border-radius: 40px;
      margin: 0
    }

    input[type=range]:focus {
      outline: 0
    }

    input[type=range]::-webkit-slider-runnable-track {
      width: 100%;
      height: 2px;
      cursor: pointer;
      background: #EFEFEF;
      border-radius: 0;
      border: 0 solid #EFEFEF
    }

    input[type=range]::-webkit-slider-thumb {
      border: 1px solid rgba(0, 0, 30, 0);
      height: 22px;
      width: 22px;
      border-radius: 50px;
      background: #feaf3c;
      cursor: pointer;
      -webkit-appearance: none;
      margin-top: -11.5px
    }

    input[type=range]:focus::-webkit-slider-runnable-track {
      background: #EFEFEF
    }

    input[type=range]::-moz-range-track {
      width: 100%;
      height: 2px;
      cursor: pointer;
      background: #EFEFEF;
      border-radius: 0;
      border: 0 solid #EFEFEF
    }

    input[type=range]::-moz-range-thumb {
      border: 1px solid rgba(0, 0, 30, 0);
      height: 22px;
      width: 22px;
      border-radius: 50px;
      background: #feaf3c;
      cursor: pointer
    }

    input[type=range]::-ms-track {
      width: 100%;
      height: 2px;
      cursor: pointer;
      background: 0 0;
      border-color: transparent;
      color: transparent
    }

    input[type=range]::-ms-fill-lower {
      background: #EFEFEF;
      border: 0 solid #EFEFEF;
      border-radius: 0
    }

    input[type=range]::-ms-fill-upper {
      background: #EFEFEF;
      border: 0 solid #EFEFEF;
      border-radius: 0
    }

    input[type=range]::-ms-thumb {
      border: 1px solid rgba(0, 0, 30, 0);
      height: 22px;
      width: 22px;
      border-radius: 50px;
      background: #feaf3c;
      cursor: pointer;
      height: 2px
    }

    input[type=range]:focus::-ms-fill-lower {
      background: #EFEFEF
    }

    input[type=range]:focus::-ms-fill-upper {
      background: #363636
    }

    select {
      border: 1px solid #363636;
      font-size: 14px;
      height: 22px;
      outline: 0;
      border-radius: 5px
    }

    /* CHECK THIS */
    .save {
      position: absolute;
      right: 210px;
      top: 19px;
      height: 15px;
      line-height: 15px;
      padding: 5px;
      text-decoration: none;
      cursor: pointer
    }

    .close {
      position: absolute;
      right: 195px;
      top: 20px;
      background: #ff3034;
      width: 15px;
      height: 15px;
      border-radius: 100px;
      color: #fff;
      text-align: center;
      line-height: 18px;
      cursor: pointer
    }
    
    /* .inline-button {
      min-width: 47px;
      box-shadow: none
    } */
    /* 
    .inline-button {
      line-height: 20px;
      margin: 2px;
      padding: 1px 4px 2px 4px;
    } */

    /* input[type=text] {
      border: 1px solid #363636;
      font-size: 14px;
      height: 20px;
      margin: 1px;
      outline: 0;
      border-radius: 5px
    } */

    /* For testing */
    #video-container {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px 0;
      /* min-height: 545px */
    }

    #stream-div {
      background: none;
      /* display: flex;
              justify-content: center;
              align-items: center;
              min-height: 545px */
    }

    figure {
      padding: 0px;
      margin: 0;
      -webkit-margin-before: 0;
      margin-block-start: 0;
      -webkit-margin-after: 0;
      margin-block-end: 0;
      -webkit-margin-start: 0;
      margin-inline-start: 0;
      -webkit-margin-end: 0;
      margin-inline-end: 0
    }

    figure img {
      display: block;
      width: 100%;
      height: auto;
      border-radius: 4px;
      margin-top: 8px;
    }

    @media (min-width: 800px) and (orientation:landscape) {
      #content {
        display: flex;
        flex-wrap: nowrap;
        align-items: stretch
      }

      figure img {
        display: block;
        max-width: 100%;
        max-height: calc(100vh - 40px);
        width: auto;
        height: auto
      }

      figure {
        padding: 0 0 0 0px;
        margin: 0;
        -webkit-margin-before: 0;
        margin-block-start: 0;
        -webkit-margin-after: 0;
        margin-block-end: 0;
        -webkit-margin-start: 0;
        margin-inline-start: 0;
        -webkit-margin-end: 0;
        margin-inline-end: 0
      }
    }

    .image-container {
      position: relative;
      min-width: 160px
    }

  </style>

</head>

<body>

  <header>
      <div id="header-top"></div>
      <div id="deskpet">DeskPet</div>
      <img id="lynx-logo" src="lynxmotion-logo.png" />
        <nav>
          <section id="nav-bar">
            <div class="trapezoid "></div>
            <div id="nav-space"></div>
            <button class="nav-icons" id="toggle-stream"><i class="bi bi-camera-video"></i></button>
            <button class="nav-icons disabled" id="get-still" disabled="disabled"><i class="bi bi-camera"></i></button>
            <button class="nav-icons" id="object-detect-group"><i class="bi bi-umbrella"></i></button>
            <button class="nav-icons" id="face-detect"><i class="bi bi-person-fill"></i></button>
            <button class="nav-icons disabled" id="face-recog" disabled="disabled"><i class="bi bi-person-badge-fill"></i></button>
            <button class="nav-icons disabled" id="face-add" disabled="disabled"><i class="bi bi-person-plus"></i></button>
            <label class="nav-icons" for="nav-tog-rc" class="toggle-section-label"><i class="bi bi-controller"></i></label>
            <label class="nav-icons" for="nav-tog-cam" class="toggle-section-label"><i class="bi bi-gear-fill"></i></label>
          </section>
        </nav>
  </header>

    <input type="checkbox" id="nav-tog-cam" class="hidden toggle-section-button" checked="checked">
    <section class="toggle-section">
    <div id="settings">
      <div class="input-group" id="framesize-group">
        <label for="framesize">Resolution</label>
          <select id="framesize" class="default-action">
            <!-- 5MP -->
            <!-- <option value="21" selected="selected">QSXGA(2560x1920)</option> -->
            <!-- <option value="20">P FHD(1080x1920)</option> -->
            <!-- <option value="19">WQXGA(2560x1600)</option> -->
            <option value="4" selected="selected">QHD(2560x1440)</option>
            <!-- 3MP -->
            <!-- <option value="17">QXGA(2048x1564)</option> -->
            <!-- <option value="16">P 3MP(864x1564)</option> -->
            <!-- <option value="15">P HD(720x1280)</option> -->
            <option value="3">FHD(1920x1080)</option>
            <!-- 2MP -->
            <!-- <option value="13">UXGA(1600x1200)</option> -->
            <!-- <option value="12">SXGA(1280x1024)</option> -->
            <option value="2">HD(1280x720)</option>
            <!-- <option value="10">XGA(1024x768)</option> -->
            <!-- <option value="9">SVGA(800x600)</option> -->
            <option value="1">VGA(640x480)</option>
            <!-- <option value="7">HVGA(480x320)</option> -->
            <!-- <option value="6">CIF(400x296)</option> -->
            <option value="0">QVGA(320x240)</option>
            <!-- <option value="4">240x240</option> -->
            <!-- <option value="3">HQVGA(240x176)</option> -->
            <!-- <option value="2">QCIF(176x144)</option> -->
            <!-- <option value="1">QQVGA(160x120)</option> -->
            <!-- <option value="0">96x96</option> -->
        </select>
      </div>
      <div class="input-group" id="brightness-group">
        <label for="brightness">Brightness</label>
        <div class="range-min">-3</div>
        <input type="range" id="brightness" min="-3" max="3" value="0" class="default-action">
        <div class="range-max">3</div>
      </div>
      <div class="input-group" id="contrast-group">
        <label for="contrast">Contrast</label>
        <div class="range-min">-3</div>
        <input type="range" id="contrast" min="-3" max="3" value="0" class="default-action">
        <div class="range-max">3</div>
      </div>
      <div class="input-group" id="saturation-group">
        <label for="saturation">Saturation</label>
        <div class="range-min">-4</div>
        <input type="range" id="saturation" min="-4" max="4" value="0" class="default-action">
        <div class="range-max">4</div>
      </div>
    </section>

  <input type="checkbox" id="nav-tog-rc" class="hidden toggle-section-button" checked="checked">
  <section class="toggle-section">
    <div id="control-box">
      <table>
        <tr align="center">
          <td colspan="3"><button class="button rc-buttons" text-align="center" onmousedown="toggleCheckbox('forward');"
              ontouchstart="toggleCheckbox('forward');" onmouseup="toggleCheckbox('stop');"
              ontouchend="toggleCheckbox('stop');">&#x21E7</button></td>
        </tr>
        <tr align="center">
          <td><button class="button rc-buttons" text-align="center" onmousedown="toggleCheckbox('left');"
              ontouchstart="toggleCheckbox('left');" onmouseup="toggleCheckbox('stop');"
              ontouchend="toggleCheckbox('stop');">&#x21E6</button></td>
          <td align="center"><button class="button rc-buttons" onmousedown="toggleCheckbox('stop');"
              ontouchstart="toggleCheckbox('stop');">&#9632</button></td>
          <td align="center"><button class="button rc-buttons" onmousedown="toggleCheckbox('right');"
              ontouchstart="toggleCheckbox('right');" onmouseup="toggleCheckbox('stop');"
              ontouchend="toggleCheckbox('stop');">&#x21E8</button></td>
        </tr>
        <tr align="center">
          <td colspan="3"><button class="button rc-buttons" onmousedown="toggleCheckbox('backward');"
              ontouchstart="toggleCheckbox('backward');" onmouseup="toggleCheckbox('stop');"
              ontouchend="toggleCheckbox('stop');">&#x21E9</button></td>
        </tr>
      </table>
    </div>
  </section>

  <div id="stream-div">
    <figure>
      <div id="stream-container" class="image-container hidden">
          <a id="save-still" href="#" class="button save hidden" download="capture.jpg">Save</a>
          <div class="close hidden" id="close-stream">×</div>
          <img id="stream" src="" crossorigin>
      </div>
    </figure>
  </div>
        
  <!-- Test with webcam -->
  <div id="video-container">
    <video autoplay="true" id="videoElement"></video>
  </div>

  <script>

    var gateway = `ws://${window.location.hostname}/ws`;
    var websocket;

    // Test with webcam
    var video = document.querySelector("#videoElement");

    if (navigator.mediaDevices.getUserMedia) {
      navigator.mediaDevices.getUserMedia({ video: true })
        .then(function (stream) {
          video.srcObject = stream;
        })
        .catch(function (err0r) {
          console.log("Something went wrong!");
        });
    }
    window.addEventListener('load', initWebSocket);
    function initWebSocket() {
      console.log('Trying to open a WebSocket connection...');
      websocket = new WebSocket(gateway);
      websocket.onopen = onOpen;
      websocket.onclose = onClose;
      websocket.onmessage = onMessage;
    }
    function onOpen(event) {
      console.log('Ws Connection opened');
    }
    function onClose(event) {
      console.log('Ws Connection closed');
      setTimeout(initWebSocket, 2000);
    }
    function onMessage(event) {
      console.log(event.data);
    }

    function toggleCheckbox(x) {
      websocket.send(x);
      console.log(x);
    }
    // Buttons Test
    /*
    function toggleCheckbox(x) {
      var xhr = new XMLHttpRequest();
      xhr.open("GET", "/action?go=" + x, true);
      xhr.send();
    }
    */

    // window.onload = document.getElementById("photo").src =     window.location.href.slice(0, -1) + ":81/stream";

    document.addEventListener('DOMContentLoaded', function (event) {
      var baseHost = document.location.origin
      var streamUrl = baseHost + ':81'
      function fetchUrl(url, cb) {
        fetch(url)
          .then(function (response) {
            if (response.status !== 200) {
              cb(response.status, response.statusText);
            } else {
              response.text().then(function (data) {
                cb(200, data);
              }).catch(function (err) {
                cb(-1, err);
              });
            }
          })
          .catch(function (err) {
            cb(-1, err);
          });
      }

      function setWindow(start_x, start_y, end_x, end_y, offset_x, offset_y, total_x, total_y, output_x, output_y, scaling, binning, cb) {
        fetchUrl(`${baseHost}/resolution?sx=${start_x}&sy=${start_y}&ex=${end_x}&ey=${end_y}&offx=${offset_x}&offy=${offset_y}&tx=${total_x}&ty=${total_y}&ox=${output_x}&oy=${output_y}&scale=${scaling}&binning=${binning}`, cb);
      }

      const saveButton = document.getElementById('save-still');

      saveButton.onclick = () => {
        var canvas = document.createElement("canvas");
        canvas.width = view.width;
        canvas.height = view.height;
        document.body.appendChild(canvas);
        var context = canvas.getContext('2d');
        context.drawImage(view, 0, 0);
        try {
          var dataURL = canvas.toDataURL('image/jpeg');
          saveButton.href = dataURL;
          var d = new Date();
          saveButton.download = d.getFullYear() + ("0" + (d.getMonth() + 1)).slice(-2) + ("0" + d.getDate()).slice(-2) + ("0" + d.getHours()).slice(-2) + ("0" + d.getMinutes()).slice(-2) + ("0" + d.getSeconds()).slice(-2) + ".jpg";
        } catch (e) {
          console.error(e);
        }
        canvas.parentNode.removeChild(canvas);
      }

      const hide = el => {
        el.classList.add('hidden')
      }
      const show = el => {
        el.classList.remove('hidden')
      }

      const disable = el => {
        el.classList.add('disabled')
        el.disabled = true
      }

      const enable = el => {
        el.classList.remove('disabled')
        el.disabled = false
      }

      const updateValue = (el, value, updateRemote) => {
        updateRemote = updateRemote == null ? true : updateRemote
        let initialValue
        if (el.type === 'checkbox') {
          initialValue = el.checked
          value = !!value
          el.checked = value
        } else {
          initialValue = el.value
          el.value = value
        }

        if (updateRemote && initialValue !== value) {
          updateConfig(el);
        } else if (!updateRemote) {
          if (el.id === "face-recog") {
            value ? enable(enrollButton) : disable(enrollButton)
          }
        }
      }

      function updateConfig(el) {
        let value
        switch (el.type) {
          case 'checkbox':
            value = el.checked ? 1 : 0
            break
          case 'range':
          case 'select-one':
            value = el.value
            break
          case 'button':
          case 'submit':
            value = '1'
            break
          default:
            return
        }

        const query = `${baseHost}/control?var=${el.id}&val=${value}`

        fetch(query)
          .then(response => {
            console.log(`request to ${query} finished, status: ${response.status}`)
          })
      }

      // Attach default on change action
      document
        .querySelectorAll('.default-action')
        .forEach(el => {
          el.onchange = () => updateConfig(el)
        })

      document
        .querySelectorAll('.close')
        .forEach(el => {
          el.onclick = () => {
            hide(el.parentNode)
          }
        })

      // read initial values
      fetch(`${baseHost}/status`)
        .then(function (response) {
          return response.json()
        })
        .then(function (state) {
          document
            .querySelectorAll('.default-action')
            .forEach(el => {
              updateValue(el, state[el.id], false)
            })
          document
            .querySelectorAll('.reg-action')
            .forEach(el => {
              let reg = el.attributes.reg ? parseInt(el.attributes.reg.nodeValue) : 0;
              if (reg == 0) {
                return;
              }
              updateRegValue(el, state['0x' + reg.toString(16)], false)
            })
        })

      const view = document.getElementById('stream')
      const viewContainer = document.getElementById('stream-container')
      const stillButton = document.getElementById('get-still')
      const streamButton = document.getElementById('toggle-stream')
      const enrollButton = document.getElementById('face-add')
      const closeButton = document.getElementById('close-stream')

      streamButton.onclick = () => {
        const streamEnabled = streamButton.innerHTML === '<i class="bi bi-camera-video-off"></i>'
        if (streamEnabled) {
          stopStream()
        } else {
          startStream()
        }
      }

      const stopStream = () => {
        window.stop();
        streamButton.innerHTML = '<i class="bi bi-camera-video"></i>'
        document.getElementById('get-still').classList.add('disabled')
        document.getElementById('get-still').disabled = true
      }

      const startStream = () => {
        view.src = `${streamUrl}/stream`
        show(viewContainer)
        streamButton.innerHTML = '<i class="bi bi-camera-video-off"></i>'
        document.getElementById('get-still').classList.remove('disabled')
        document.getElementById('get-still').disabled = false
      }

      stillButton.onclick = () => {
        stopStream()
        view.src = `${baseHost}/capture?_cb=${Date.now()}`
        show(viewContainer)
      }

      // closeButton.onclick = () => {
      //   stopStream()
      //   hide(viewContainer)
      // }

      enrollButton.onclick = () => {
        updateConfig(enrollButton)
      }

      // Detection and framesize
      const detectButton = document.getElementById('face-detect')
      const recogButton = document.getElementById('face-recog')
      const framesize = document.getElementById('framesize')

      detectButton.onclick = () => {
        const detectEnabled = detectButton.innerHTML === '<i class="bi bi-person-square"></i>'
        if (detectEnabled) {
          stopDet()
        } else {
          startDet()
        }
      }

      const stopDet = () => {
        detectButton.innerHTML = '<i class="bi bi-person-fill"></i>'
        document.getElementById('face-recog').classList.add('disabled')
        document.getElementById('face-recog').disabled = true
      }

      const startDet = () => {
        detectButton.innerHTML = '<i class="bi bi-person-square"></i>'
        document.getElementById('face-recog').classList.remove('disabled')
        document.getElementById('face-recog').disabled = false
      }

      recogButton.onclick = () => {
        const recogEnabled = recogButton.innerHTML === '<i class="bi bi-person-badge-fill"></i>'
        if (recogEnabled) {
          stopRecog()
        } else {
          startRecog()
        }
        // if (framesize.value > 0) {
        //   alert("Please select QVGA or lower resolution before enabling this feature!");
        //   document.getElementById('face-det').classList.add('disabled')
        //   document.getElementById('face-det').disabled = true
        //   return;
        // }
        // updateConfig(detect)
        // if (!detect.checked) {
        //   disable(enrollButton)
        //   document.getElementById('face-recog').classList.remove('disabled')
        //   document.getElementById('face-recog').disabled = false
        // }
      }

      const stopRecog = () => {
        recogButton.innerHTML = '<i class="bi bi-person-badge"></i>'
        // document.getElementById('face-add').classList.add('disabled')
        // document.getElementById('face-add').disabled = true
      }

      const startRecog = () => {
        recogButton.innerHTML = '<i class="bi bi-person-badge-fill"></i>'
        // document.getElementById('face-add').classList.remove('disabled')
        // document.getElementById('face-add').disabled = false
      }

      framesize.onchange = () => {
        updateConfig(framesize)
        if (framesize.value > 0) {
          updateValue(detect, false)
          updateValue(recognize, false)
        }
      }

      recognize.onchange = () => {
        if (framesize.value > 0) {
          alert("Please select QVGA or lower resolution before enabling this feature!");
          updateValue(recognize, false)
          return;
        }
        updateConfig(recognize)
        if (recognize.checked) {
          enable(enrollButton)
          updateValue(detect, true)
        } else {
          disable(enrollButton)
        }
      }

    })
  </script>
</body>

</html>